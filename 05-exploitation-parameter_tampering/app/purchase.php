<?php
session_start();
include('config.php');

if (!isset($_SESSION['username'])) {
    header("Location: index.php");
    exit();
}

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $quantities = $_POST['quantity'];
    $prices = $_POST['price'];
    $total_price = 0;
    $details = "";

    foreach ($quantities as $ticket_id => $quantity) {
        if ($quantity > 0) {
            $price_from_user = floatval($prices[$ticket_id]);
            $subtotal = $price_from_user * $quantity;
            $total_price += $subtotal;
            $query = "SELECT name FROM tickets WHERE id = $ticket_id";
            $result = $conn->query($query);
            $ticket_name = $result->fetch_assoc()['name'];

            $details .= "$quantity x $ticket_name (Rp " . number_format($price_from_user, 0, ',', '.') . ") = Rp " . number_format($subtotal, 0, ',', '.') . "<br>";
        }
    }

    if ($total_price > 0) {
        $message = "Pembelian berhasil! Anda telah membeli tiket sebagai berikut:<br><br>" . $details . "<br>Total Harga: Rp " . number_format($total_price, 0, ',', '.');
    } else {
        $message = "Anda belum memilih tiket apapun.";
    }
} else {
    header("Location: home.php");
    exit();
}

$conn->close();
?>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfirmasi Pembelian Tiket</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header text-center bg-success text-white">
                        <h4>Konfirmasi Pembelian Tiket</h4>
                    </div>
                    <div class="card-body">
                        <p class="text-center"><?php echo $message; ?></p>
                        <hr>
                        <div class="text-center mt-4">
                            <h5>Pembayaran via QRIS</h5>
                            <img src="qris_dummy.png" alt="QRIS Payment" style="width: 200px; height: 200px;">
                        </div>
                        <div class="text-center mt-4">
                            <a href="home.php" class="btn btn-primary">Kembali ke Beranda</a>
                            <a href="logout.php" class="btn btn-danger">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
