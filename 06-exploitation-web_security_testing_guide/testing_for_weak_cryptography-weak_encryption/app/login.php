<?php
session_start();
include 'config.php';

function writeToLog($message) {
    $logFile = 'log.txt';
    
    if (!file_exists($logFile)) {
        file_put_contents($logFile, "Log file created at " . date("Y-m-d H:i:s") . PHP_EOL);
    }
    
    $currentTime = date("Y-m-d H:i:s");
    $formattedMessage = "[$currentTime] $message" . PHP_EOL;
    file_put_contents($logFile, $formattedMessage, FILE_APPEND);
}

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $username = $conn->real_escape_string($_POST['username']);
    $password = $conn->real_escape_string($_POST['password']);
    $password_md5 = md5($password);

    $sql = "SELECT * FROM users WHERE username='$username'";
    $result = $conn->query($sql);
    
    if ($result->num_rows > 0) {
        $user = $result->fetch_assoc();
        
        if ($password_md5 === $user['password']) {
            $_SESSION['username'] = $user['username'];
            $_SESSION['name'] = $user['name'];
            header("Location: home.php");
            exit();
        } else {
            writeToLog("ERROR: Incorrect password for username: $username, attempted password hash: $password_md5");
            header("Location: index.php?error=Incorrect password. See details in <a href='log.txt' target='_blank'>log.txt</a>");
            exit();
        }
    } else {
        writeToLog("ERROR: Username not found: $username, attempted password hash: $password_md5");
        header("Location: index.php?error=User not found. See details in <a href='log.txt' target='_blank'>log.txt</a>");
        exit();
    }
}
?>
