<?php
session_start();

if (!isset($_SESSION['user_id'])) {
    header("Location: index.php");
    exit();
}

include('config.php');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $user_id = $_SESSION['user_id'];
    $quantities = $_POST['quantity'];
    $prices = $_POST['price'];
    $total_price = 0;
    $details = "";

    foreach ($quantities as $ticket_id => $quantity) {
        if ($quantity > 0) {
            $price_from_user = floatval($prices[$ticket_id]);
            $subtotal = $price_from_user * $quantity;
            $total_price += $subtotal;
            $query = "SELECT name FROM tickets WHERE id = $ticket_id";
            $result = $conn->query($query);
            $ticket_name = $result->fetch_assoc()['name'];

            $details .= "$quantity x $ticket_name (Rp " . number_format($price_from_user, 0, ',', '.') . ") = Rp " . number_format($subtotal, 0, ',', '.') . "<br>";
        }
    }

    $new_balance = $_SESSION['balance'] - $total_price;
    $query = "UPDATE users SET balance = $new_balance WHERE id = $user_id";
    $conn->query($query);

    foreach ($quantities as $ticket_id => $quantity) {
        if ($quantity > 0) {
            $price_from_user = floatval($prices[$ticket_id]);
            $subtotal = $price_from_user * $quantity;

            $query = "INSERT INTO transactions (user_id, ticket_id, quantity, total_price) VALUES ($user_id, $ticket_id, $quantity, $subtotal)";
            $conn->query($query);
        }
    }

    $_SESSION['balance'] = $new_balance;

    $message = "Pembelian berhasil! Anda telah membeli tiket sebagai berikut:<br><br>" . $details . "<br>Total Harga: Rp " . number_format($total_price, 0, ',', '.') . "<br>Sisa Saldo Anda: Rp " . number_format($new_balance, 0, ',', '.');
} else {
    header("Location: home.php");
    exit();
}

$conn->close();
?>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfirmasi Pembelian Tiket</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header text-center bg-success text-white">
                        <h4>Konfirmasi Pembelian Tiket</h4>
                    </div>
                    <div class="card-body">
                        <p class="text-center"><?php echo $message; ?></p>
                        <div class="text-center mt-4">
                            <a href="home.php" class="btn btn-primary">Kembali ke Beranda</a>
                            <a href="logout.php" class="btn btn-danger">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
